/**
 * This file is part of ReSampled SoundBox.
 *
 * Based on SoundBox by Marcus Geelnard (c) 2011-2013
 * 2015 pointofpresence
 * ReSampled.SoundBox (resampled-sound-box) - Online music tracker
 * @version v0.0.1
 * @build Sun Jul 12 2015 21:32:34
 * @link https://github.com/pointofpresence/resampled-sound-box
 * @license GPL-3.0
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 * 1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 * 2. Altered source versions must be plainly marked as such, and must not be
 *    misrepresented as being the original software.
 *
 * 3. This notice may not be removed or altered from any source
 *    distribution.
 */
function gui_init(){try{var e=new CGUI;e.init()}catch(t){alert("Unexpected error: "+t.message)}}include("tracker/js/demo-songs.js"),include("tracker/js/presets.js"),include("tracker/js/player.js"),include("tracker/js/jammer.js"),include("tracker/js/rle.js"),include("tracker/js/third_party/deflate.js"),include("tracker/js/third_party/inflate.js"),include("tracker/js/third_party/Blob.js"),include("tracker/js/third_party/FileSaver.js"),include("tracker/js/third_party/WebMIDIAPI.js");var CBinParser=function(e){var t=e,n=0;this.getUBYTE=function(){return 255&t.charCodeAt(n++)},this.getUSHORT=function(){var e=255&t.charCodeAt(n)|(255&t.charCodeAt(n+1))<<8;return n+=2,e},this.getULONG=function(){var e=255&t.charCodeAt(n)|(255&t.charCodeAt(n+1))<<8|(255&t.charCodeAt(n+2))<<16|(255&t.charCodeAt(n+3))<<24;return n+=4,e},this.getFLOAT=function(){var e=this.getULONG();if(0==e)return 0;var t=2147483648&e,n=e>>23&255,a=1+(8388607&e)/8388608,o=a*Math.pow(2,n-127);return t?-o:o},this.getTail=function(){var e=t.slice(n);return n=t.length,e}},CBinWriter=function(){var e="";this.putUBYTE=function(t){e+=String.fromCharCode(t)},this.putUSHORT=function(t){e+=String.fromCharCode(255&t,t>>8&255)},this.putULONG=function(t){e+=String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)},this.putFLOAT=function(e){var t=0;if(0!=e){var n=0;0>e&&(n=2147483648,e=-e);for(var a=150;8388608>e;)e*=2,a--;for(;e>=16777216;)e/=2,a++;t=n|(255&a)<<23|8388607&e}this.putULONG(t)},this.append=function(t){e+=t},this.getData=function(){return e}},CAudioTimer=function(){var e=null,t=0,n=[0,0,0,0,0,0],a=0;this.setAudioElement=function(t){e=t},this.currentTime=function(){if(!e)return 0;var o=.001*(new Date).getTime(),r=o-t,d=e.currentTime,i=d-r;if(.01>d||i>.2||-.2>i){r=d,t=o-r;for(var s=0;s<n.length;s++)n[s]=0}for(var c=0,s=0;s<n.length;s++)c+=n[s];return c/=n.length,n[a]=i,a=(a+1)%n.length,r+c},this.reset=function(){t=.001*(new Date).getTime();for(var e=0;e<n.length;e++)n[e]=0}},CGUI=function(){var e,t,n,a,o,r="tracker/image/gui/",d=0,i=1,s=2,c=3,u=128,l=36,m=s,f=5,p=0,g=0,v=0,E=0,B=0,w=0,h=0,y=0,_=0,I=0,L=!1,T=!1,D=!1,U=[],b=[],x=[],Y=[],C={},k=null,M=new CAudioTimer,P=new CPlayer,N=new Image,O=new Image,q=new Image,S=new CJammer,A=["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"],R=[26,1,63,3,116,6,150,8,184,10,238,13,274,15,327,18,362,20,394,22],F=[],j=function(e){var t=e.indexOf("?");return e.slice(0,t>=0?t:e.length)},G=function(e){var t=e.indexOf("?")+1,n=e.indexOf("#")+1||e.length+1,a=e.slice(t,n-1),o={};if(a===e||""===a)return o;for(var r=a.replace(/\+/g," ").split("&"),d=0;d<r.length;d++){var i=r[d].split("="),s=decodeURIComponent(i[0]),c=decodeURIComponent(i[1]);s in o||(o[s]=[]),o[s].push(2===i.length?c:null)}return o},H=function(e){var t=void 0;if(e){var n=e,a="";if(0==n.indexOf("data:")){var o=n.indexOf("base64,");o>0&&(a=n.substr(o+7))}else for(var r=0;r<n.length;++r){var d=n[r];"-"===d&&(d="+"),"_"===d&&(d="/"),a+=d}try{t=atob(a)}catch(i){t=void 0}}return t},V=function(t){for(var n=btoa(t),a="",o=0;o<n.length;++o){var r=n[o];"+"===r&&(r="-"),"/"===r&&(r="_"),"="===r&&(r=""),a+=r}return e+"?data="+a},X=function(e){return Math.round(661500/e)},W=function(){return Math.round(661500/C.rowLen)},Q=0,z=1,J=2,K=3,Z=4,$=5,ee=6,te=7,ne=8,ae=9,oe=10,re=11,de=12,ie=13,se=14,ce=15,ue=16,le=17,me=18,fe=19,pe=20,ge=21,ve=22,Ee=23,Be=24,we=25,he=function(){var e,t,n,a,o,r={};r.rowLen=X(120),r.endPattern=2,r.patternLen=32;var d;for(e=0;e<gInstrumentPresets.length;++e)if(gInstrumentPresets[e].i){d=gInstrumentPresets[e];break}for(r.songData=[],e=0;8>e;e++){for(a={},a.i=[],t=0;t<=d.i.length;++t)a.i[t]=d.i[t];for(a.p=[],t=0;u>t;t++)a.p[t]=0;for(a.c=[],t=0;l>t;t++){for(o={},o.n=[],n=0;n<4*r.patternLen;n++)o.n[n]=0;for(o.f=[],n=0;n<2*r.patternLen;n++)o.f[n]=0;a.c[t]=o}r.songData[e]=a}return r.songData[0].p[0]=1,r},ye=function(e){var t=new CBinWriter;t.putULONG(e.rowLen),t.putUBYTE(e.endPattern-2),t.putUBYTE(e.patternLen);var n,a,o,r,d;for(n=0;8>n;n++){for(r=e.songData[n],t.putUBYTE(r.i[Q]),t.putUBYTE(r.i[z]),t.putUBYTE(r.i[J]),t.putUBYTE(r.i[K]),t.putUBYTE(r.i[Z]),t.putUBYTE(r.i[$]),t.putUBYTE(r.i[ee]),t.putUBYTE(r.i[te]),t.putUBYTE(r.i[ne]),t.putUBYTE(r.i[ae]),t.putUBYTE(r.i[oe]),t.putUBYTE(r.i[re]),t.putUBYTE(r.i[de]),t.putUBYTE(r.i[ie]),t.putUBYTE(r.i[se]),t.putUBYTE(r.i[ce]),t.putUBYTE(r.i[ue]),t.putUBYTE(r.i[le]),t.putUBYTE(r.i[me]),t.putUBYTE(r.i[fe]),t.putUBYTE(r.i[pe]),t.putUBYTE(r.i[ge]),t.putUBYTE(r.i[ve]),t.putUBYTE(r.i[Ee]),t.putUBYTE(r.i[Be]),t.putUBYTE(r.i[we]),a=0;u>a;a++)t.putUBYTE(r.p[a]);for(a=0;l>a;a++){for(d=r.c[a],o=0;o<4*e.patternLen;o++)t.putUBYTE(d.n[o]);for(o=0;o<2*e.patternLen;o++)t.putUBYTE(d.f[o])}}var i,s,c=t.getData(),m=0;for(n=9;n>0;n--)if(i=RawDeflate.deflate(c,n),s=RawDeflate.inflate(i),c===s){m=2;break}return 0==m&&(i=rle_encode(t.getData()),s=rle_decode(i),c===s?m=1:i=c),t=new CBinWriter,t.putULONG(2020557395),t.putUBYTE(10),t.putUBYTE(m),t.append(i),t.getData()},_e=function(e){var t=new CBinParser(e),n={},a=t.getULONG(),o=t.getUBYTE();if(2020557395!=a||1>o||o>10)return void 0;if(o>=8){var r,d=t.getUBYTE(),i=t.getTail();switch(d){default:case 0:r=i;break;case 1:r=rle_decode(i);break;case 2:r=RawDeflate.inflate(i)}t=new CBinParser(r)}n.rowLen=t.getULONG(),n.endPattern=t.getUBYTE()+2,n.patternLen=o>=10?t.getUBYTE():32,n.songData=[];var s,c,m,f,p;for(s=0;8>s;s++){f={},f.i=[],6>o?(f.i[J]=t.getUBYTE(),f.i[K]=t.getUBYTE(),f.i[z]=t.getUBYTE(),f.i[Q]=t.getUBYTE()):(f.i[Q]=t.getUBYTE(),f.i[z]=t.getUBYTE(),f.i[J]=t.getUBYTE(),f.i[K]=t.getUBYTE()),6>o?(f.i[ee]=t.getUBYTE(),f.i[te]=t.getUBYTE(),f.i[ne]=t.getUBYTE(),f.i[$]=t.getUBYTE(),f.i[Z]=t.getUBYTE()):(f.i[Z]=t.getUBYTE(),f.i[$]=t.getUBYTE(),f.i[ee]=t.getUBYTE(),f.i[te]=t.getUBYTE(),f.i[ne]=t.getUBYTE()),f.i[ae]=t.getUBYTE(),5>o?(f.i[oe]=Math.round(Math.sqrt(t.getULONG())/2),f.i[re]=Math.round(Math.sqrt(t.getULONG())/2),f.i[de]=Math.round(Math.sqrt(t.getULONG())/2)):(f.i[oe]=t.getUBYTE(),f.i[re]=t.getUBYTE(),f.i[de]=t.getUBYTE()),6>o?(f.i[le]=t.getUBYTE(),f.i[me]=5>o?Math.round(t.getUSHORT()/43.23529):t.getUBYTE(),f.i[fe]=t.getUBYTE(),f.i[we]=t.getUBYTE(),f.i[Be]=t.getUBYTE(),f.i[Ee]=t.getUBYTE(),f.i[ve]=t.getUBYTE(),f.i[pe]=t.getUBYTE(),f.i[ge]=t.getUBYTE(),f.i[ue]=t.getUBYTE(),f.i[ce]=t.getUBYTE(),f.i[se]=t.getUBYTE(),f.i[ie]=t.getUBYTE()):(f.i[ie]=t.getUBYTE(),f.i[se]=t.getUBYTE(),f.i[ce]=t.getUBYTE(),f.i[ue]=t.getUBYTE(),f.i[le]=t.getUBYTE(),f.i[me]=t.getUBYTE(),f.i[fe]=t.getUBYTE(),f.i[pe]=t.getUBYTE(),f.i[ge]=t.getUBYTE(),f.i[ve]=t.getUBYTE(),f.i[Ee]=t.getUBYTE(),f.i[Be]=t.getUBYTE(),f.i[we]=t.getUBYTE());var g=9>o?48:u;for(f.p=[],c=0;g>c;c++)f.p[c]=t.getUBYTE();for(c=g;u>c;c++)f.p[c]=0;var v=9>o?10:l;for(f.c=[],c=0;v>c;c++){if(p={},p.n=[],1==o)for(m=0;m<n.patternLen;m++)p.n[m]=t.getUBYTE(),p.n[m+n.patternLen]=0,p.n[m+2*n.patternLen]=0,p.n[m+3*n.patternLen]=0;else for(m=0;m<4*n.patternLen;m++)p.n[m]=t.getUBYTE();if(p.f=[],4>o)for(m=0;m<2*n.patternLen;m++)p.f[m]=0;else for(m=0;m<2*n.patternLen;m++)p.f[m]=t.getUBYTE();f.c[c]=p}for(c=v;l>c;c++){for(p={},p.n=[],m=0;m<4*n.patternLen;m++)p.n[m]=0;for(p.f=[],m=0;m<2*n.patternLen;m++)p.f[m]=0;f.c[c]=p}3>o&&(2==f.i[Q]&&(f.i[z]=Math.round(f.i[z]/2)),2==f.i[Z]&&(f.i[$]=Math.round(f.i[$]/2)),2==f.i[ie]&&(f.i[se]=Math.round(f.i[se]/2)),f.i[ge]=f.i[ge]<224?f.i[ge]+32:255),7>o&&(f.i[fe]=255-f.i[fe]),n.songData[s]=f}return n},Ie=function(e){if(3333!=e.length)return void 0;if((255&e.charCodeAt(3332))>48)return void 0;var t=new CBinParser(e),n={};n.rowLen=t.getULONG(),n.patternLen=32,n.songData=[];var a,o,r,d,i,s;for(a=0;8>a;a++){for(d={},d.i=[],d.i[J]=12*(t.getUBYTE()-8)+128,d.i[J]+=t.getUBYTE(),t.getUBYTE(),d.i[K]=t.getUBYTE(),d.i[z]=t.getUBYTE(),d.i[Q]=t.getUBYTE(),d.i[ee]=12*(t.getUBYTE()-8)+128,d.i[ee]+=t.getUBYTE(),d.i[te]=t.getUBYTE(),d.i[ne]=t.getUBYTE(),d.i[$]=t.getUBYTE(),d.i[Z]=t.getUBYTE(),d.i[ae]=t.getUBYTE(),t.getUBYTE(),t.getUBYTE(),t.getUBYTE(),d.i[oe]=Math.round(Math.sqrt(t.getULONG())/2),d.i[re]=Math.round(Math.sqrt(t.getULONG())/2),d.i[de]=Math.round(Math.sqrt(t.getULONG())/2),s=t.getUBYTE(),d.i[le]=t.getUBYTE(),t.getUBYTE(),t.getUBYTE(),d.i[me]=Math.round(t.getFLOAT()/43.23529),d.i[fe]=255-t.getUBYTE(),d.i[we]=t.getUBYTE(),d.i[Be]=t.getUBYTE(),d.i[Ee]=t.getUBYTE(),d.i[ve]=t.getUBYTE(),d.i[pe]=0,d.i[ge]=32,t.getUBYTE(),d.i[ue]=t.getUBYTE(),d.i[ce]=t.getUBYTE(),d.i[se]=t.getUBYTE(),d.i[ie]=t.getUBYTE(),d.p=[],o=0;48>o;o++)d.p[o]=t.getUBYTE();for(o=48;u>o;o++)d.p[o]=0;for(d.c=[],o=0;10>o;o++){for(i={},i.n=[],r=0;32>r;r++)i.n[r]=t.getUBYTE(),i.n[r+32]=0,i.n[r+64]=0,i.n[r+96]=0;for(i.f=[],r=0;64>r;r++)i.f[r]=0;d.c[o]=i}for(o=10;l>o;o++){for(i={},i.n=[],r=0;128>r;r++)i.n[r]=0;for(i.f=[],r=0;64>r;r++)i.f[r]=0;d.c[o]=i}t.getUBYTE(),t.getUBYTE(),(d.i[le]<1||d.i[le]>3)&&(d.i[le]=2,d.i[me]=255),d.i[z]*=s/255,d.i[$]*=s/255,d.i[ae]*=s/255,2==d.i[Q]&&(d.i[z]/=2),2==d.i[Z]&&(d.i[$]/=2),2==d.i[ie]&&(d.i[se]/=2),d.i[z]=Math.round(d.i[z]),d.i[$]=Math.round(d.i[$]),d.i[ae]=Math.round(d.i[ae]),d.i[se]=Math.round(d.i[se]),n.songData[a]=d}return n.endPattern=t.getUBYTE()+2,n},Le=function(e){var t=_e(e);return t||(t=Ie(e)),t?t:void alert("Song format not recognized.")},Te=function(e){var t,n,a,o,r="";for(r+="    // This music has been exported by SoundBox. You can use it with\n",r+="    // http://sb.bitsnbites.eu/player-small.js in your own product.\n\n",r+="    // See http://sb.bitsnbites.eu/demo.html for an example of how to\n",r+="    // use it in a demo.\n\n",r+="    // Song data\n",r+="    var song = {\n",r+="      songData: [\n",t=0;8>t;t++){var d=e.songData[t];r+="        { // Instrument "+t+"\n",r+="          i: [\n",r+="          "+d.i[Q]+", // OSC1_WAVEFORM\n",r+="          "+d.i[z]+", // OSC1_VOL\n",r+="          "+d.i[J]+", // OSC1_SEMI\n",r+="          "+d.i[K]+", // OSC1_XENV\n",r+="          "+d.i[Z]+", // OSC2_WAVEFORM\n",r+="          "+d.i[$]+", // OSC2_VOL\n",r+="          "+d.i[ee]+", // OSC2_SEMI\n",r+="          "+d.i[te]+", // OSC2_DETUNE\n",r+="          "+d.i[ne]+", // OSC2_XENV\n",r+="          "+d.i[ae]+", // NOISE_VOL\n",r+="          "+d.i[oe]+", // ENV_ATTACK\n",r+="          "+d.i[re]+", // ENV_SUSTAIN\n",r+="          "+d.i[de]+", // ENV_RELEASE\n",r+="          "+d.i[ie]+", // LFO_WAVEFORM\n",r+="          "+d.i[se]+", // LFO_AMT\n",r+="          "+d.i[ce]+", // LFO_FREQ\n",r+="          "+d.i[ue]+", // LFO_FX_FREQ\n",r+="          "+d.i[le]+", // FX_FILTER\n",r+="          "+d.i[me]+", // FX_FREQ\n",r+="          "+d.i[fe]+", // FX_RESONANCE\n",r+="          "+d.i[pe]+", // FX_DIST\n",r+="          "+d.i[ge]+", // FX_DRIVE\n",r+="          "+d.i[ve]+", // FX_PAN_AMT\n",r+="          "+d.i[Ee]+", // FX_PAN_FREQ\n",r+="          "+d.i[Be]+", // FX_DELAY_AMT\n",r+="          "+d.i[we]+" // FX_DELAY_TIME\n",r+="          ],\n",r+="          // Patterns\n",r+="          p: [";var i=e.endPattern-2,s=0,c=0;for(n=0;i>=n;n++)o=d.p[n],o>s&&(s=o),o&&(c=n);for(n=0;c>=n;n++)o=d.p[n],o&&(r+=o),c>n&&(r+=",");for(r+="],\n",r+="          // Columns\n",r+="          c: [\n",n=0;s>n;n++){for(r+="            {n: [",c=0,a=0;a<4*e.patternLen;a++)d.c[n].n[a]&&(c=a);for(a=0;c>=a;a++){var u=d.c[n].n[a];u&&(r+=u),c>a&&(r+=",")}for(r+="],\n",r+="             f: [",c=0,a=0;a<2*e.patternLen;a++)d.c[n].f[a]&&(c=a);for(a=0;c>=a;a++){var l=d.c[n].f[a];l&&(r+=l),c>a&&(r+=",")}r+="]}",s-1>n&&(r+=","),r+="\n"}r+="          ]\n",r+="        }",7>t&&(r+=","),r+="\n"}return r+="      ],\n",r+="      rowLen: "+e.rowLen+",   // In sample lengths\n",r+="      patternLen: "+e.patternLen+",  // Rows per pattern\n",r+="      endPattern: "+e.endPattern+"  // End pattern\n",r+="    };\n"},De=function(e){var t=e.data[0]>>4,n=15&e.data[0],a=e.data[1],o=e.data[2];9!=n&&9==t&&o>0&&ze(a-12)},Ue=function(e){o=a.inputs()[n.selectedIndex],o.onmidimessage=De},be=function(e){a=e;var t,r=a.inputs(),d=0;for(t=0;t<r.length;t++){var i=r[t].name.toString().toLowerCase();if(-1!=i.indexOf("keyboard")){d=t;break}}if(n.options.length=0,r.length){for(t=0;t<r.length;t++)n.options[t]=new Option(r[t].name,r[t].fingerprint,t==d,t==d);o=r[d],o.onmidimessage=De,n.onchange=Ue,n.style.display="inline"}},xe=function(e){},Ye=function(){navigator.requestMIDIAccess&&(n=document.getElementById("midiInput"),navigator.requestMIDIAccess().then(be,xe))},Ce=function(e){var t=new Image;t.src=e,F.push(t)},ke=function(){for(var e,t,n=document.getElementById("instrPreset"),a=0;a<gInstrumentPresets.length;++a)t=gInstrumentPresets[a],e=document.createElement("option"),e.value=t.i?""+a:"",e.appendChild(document.createTextNode(t.name)),n.appendChild(e)},Me=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return[t,n]},Pe=function(e){var t=null;return e||(e=window.event),e.target?t=e.target:e.srcElement&&(t=e.srcElement),3==t.nodeType&&(t=t.parentNode),t},Ne=function(e,t){var n=[0,0];if(e.pageX&&e.pageY?n=[e.pageX,e.pageY]:e.clientX&&e.clientY?n=[e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,e.clientY+document.body.scrollTop+document.documentElement.scrollTop]:e.touches&&e.touches.length>0&&(n=[e.touches[0].clientX+document.body.scrollLeft+document.documentElement.scrollLeft,e.touches[0].clientY+document.body.scrollTop+document.documentElement.scrollTop]),!t)return n;var a=Me(Pe(e));return[n[0]-a[0],n[1]-a[1]]},Oe=function(){document.getElementById("bpm").blur(),document.getElementById("rpp").blur(),document.getElementById("instrPreset").blur()},qe=function(e){e!==m&&(m=e,document.getElementById("sequencer").className=m==i?"edit":"",document.getElementById("pattern").className=m==s?"edit":"",document.getElementById("fxtrack").className=m==c?"edit":"",m!=d&&(Oe(),et(),nt()))},Se=function(){document.getElementById("bpm").value=W(),document.getElementById("rpp").value=C.patternLen},Ae=function(e,t){for(var n,a=0;u>a;++a)for(var o=0;8>o;++o){if(n=document.getElementById("sc"+o+"r"+a),!t){var r=C.songData[o].p[a];n.innerHTML=r>0?""+(10>=r?r-1:String.fromCharCode(64+r-10)):""}n.className=a>=w&&y>=a&&o>=B&&h>=o?"selected":""}if(e&&(n=document.getElementById("spr"+w),n.scrollIntoView)){var d=document.getElementById("sequencer"),i=n.offsetTop-d.scrollTop;(0>i||i+10>d.offsetHeight)&&n.scrollIntoView(0>i)}},Re=function(e,t){xn();for(var n,a=B==h&&w==y,o=a?C.songData[B].p[w]-1:-1,r=0;r<C.patternLen;++r)for(var d=0;4>d;++d){if(n=document.getElementById("pc"+d+"r"+r),!t){var i="";if(o>=0){var s=C.songData[B].c[o].n[r+d*C.patternLen]-87;s>0&&(i=A[s%12]+Math.floor(s/12))}n.innerHTML!=i&&(n.innerHTML=i)}n.className=r>=g&&E>=r&&d>=p&&v>=d?"selected":""}if(e&a&&(n=document.getElementById("pc0r"+g),n.scrollIntoView)){var c=document.getElementById("pattern"),u=n.offsetTop-c.scrollTop;(0>u||u+10>c.offsetHeight)&&n.scrollIntoView(0>u)}},Fe=function(e,t){for(var n=e.toString(16).toUpperCase(),a=t-n.length,o=0;a>o;++o)n="0"+n;return n},je=function(e,t){Yn();for(var n,a=B==h&&w==y,o=a?C.songData[B].p[w]-1:-1,r=0;r<C.patternLen;++r){if(n=document.getElementById("fxr"+r),!t){var d=":";if(o>=0){var i=C.songData[B].c[o].f[r];if(i){var s=C.songData[B].c[o].f[r+C.patternLen];d=Fe(i,2)+":"+Fe(s,2)}}n.innerHTML!=d&&(n.innerHTML=d)}n.className=r>=_&&I>=r?"selected":""}if(e&a&&(n=document.getElementById("fxr"+_),n.scrollIntoView)){var c=document.getElementById("fxtrack"),u=n.offsetTop-c.scrollTop;(0>u||u+10>c.offsetHeight)&&n.scrollIntoView(0>u)}},Ge=function(e,t){p=e,g=t,v=e,E=t;for(var n=0;n<C.patternLen;++n)for(var a=0;4>a;++a){var o=document.getElementById("pc"+a+"r"+n);o.className=n==t&&a==e?"selected":""}Re(!0,!0)},He=function(e,t){v=e>=p?e:p,E=t>=g?t:g;for(var n=0;n<C.patternLen;++n)for(var a=0;4>a;++a){var o=document.getElementById("pc"+a+"r"+n);o.className=n>=g&&E>=n&&a>=p&&v>=a?"selected":""}Re(!1,!0)},Ve=function(e,t){B=e,w=t,h=e,y=t,Ae(!0,!0)},Xe=function(e,t){h=e>=B?e:B,y=t>=w?t:w,Ae(!1,!0)},We=function(e){_=e,I=e;for(var t=0;t<C.patternLen;++t){var n=document.getElementById("fxr"+t);n.className=t>=_&&I>=t?"selected":""}je(!0,!0)},Qe=function(e){I=e>=_?e:_;for(var t=0;t<C.patternLen;++t){var n=document.getElementById("fxr"+t);n.className=t>=_&&I>=t?"selected":""}je(!1,!0)},ze=function(e){var t=e+87;if(S.addNote(t),m==s&&B==h&&w==y&&p==v&&g==E){var n=C.songData[B].p[w]-1;if(n>=0)return C.songData[B].c[n].n[g+p*C.patternLen]=t,Ge(p,(g+1)%C.patternLen),Re(),!0}return!1},Je=function(e,t){var n=e.sliderProps,a=(t-n.min)/(n.max-n.min);a=0>a?0:a>1?1:a,n.nonLinear&&(a=Math.sqrt(a)),e.style.marginLeft=Math.round(191*a)+"px"},Ke=function(e,t){e.src=t?r+"box-check.png":r+"box-uncheck.png"},Ze=function(){var e=document.getElementById("instrPreset");e.selectedIndex=0},$e=function(e){var t=C.songData[B];document.getElementById("osc1_wave_sin").src=0==t.i[Q]?r+"wave-sin-sel.png":r+"wave-sin.png",document.getElementById("osc1_wave_sqr").src=1==t.i[Q]?r+"wave-sqr-sel.png":r+"wave-sqr.png",document.getElementById("osc1_wave_saw").src=2==t.i[Q]?r+"wave-saw-sel.png":r+"wave-saw.png",document.getElementById("osc1_wave_tri").src=3==t.i[Q]?r+"wave-tri-sel.png":r+"/wave-tri.png",Je(document.getElementById("osc1_vol"),t.i[z]),Je(document.getElementById("osc1_semi"),t.i[J]),Ke(document.getElementById("osc1_xenv"),t.i[K]),document.getElementById("osc2_wave_sin").src=0==t.i[Z]?r+"wave-sin-sel.png":r+"wave-sin.png",document.getElementById("osc2_wave_sqr").src=1==t.i[Z]?r+"wave-sqr-sel.png":r+"wave-sqr.png",document.getElementById("osc2_wave_saw").src=2==t.i[Z]?r+"wave-saw-sel.png":r+"wave-saw.png",document.getElementById("osc2_wave_tri").src=3==t.i[Z]?r+"wave-tri-sel.png":r+"wave-tri.png",Je(document.getElementById("osc2_vol"),t.i[$]),Je(document.getElementById("osc2_semi"),t.i[ee]),Je(document.getElementById("osc2_det"),t.i[te]),Ke(document.getElementById("osc2_xenv"),t.i[ne]),Je(document.getElementById("noise_vol"),t.i[ae]),Je(document.getElementById("env_att"),t.i[oe]),Je(document.getElementById("env_sust"),t.i[re]),Je(document.getElementById("env_rel"),t.i[de]),document.getElementById("lfo_wave_sin").src=0==t.i[ie]?r+"wave-sin-sel.png":r+"wave-sin.png",document.getElementById("lfo_wave_sqr").src=1==t.i[ie]?r+"wave-sqr-sel.png":r+"wave-sqr.png",document.getElementById("lfo_wave_saw").src=2==t.i[ie]?r+"wave-saw-sel.png":r+"wave-saw.png",document.getElementById("lfo_wave_tri").src=3==t.i[ie]?r+"wave-tri-sel.png":r+"wave-tri.png",Je(document.getElementById("lfo_amt"),t.i[se]),Je(document.getElementById("lfo_freq"),t.i[ce]),Ke(document.getElementById("lfo_fxfreq"),t.i[ue]),document.getElementById("fx_filt_lp").src=2==t.i[le]?r+"filt-lp-sel.png":r+"filt-lp.png",document.getElementById("fx_filt_hp").src=1==t.i[le]?r+"filt-hp-sel.png":r+"filt-hp.png",document.getElementById("fx_filt_bp").src=3==t.i[le]?r+"filt-bp-sel.png":r+"filt-bp.png",Je(document.getElementById("fx_freq"),t.i[me]),Je(document.getElementById("fx_res"),t.i[fe]),Je(document.getElementById("fx_dly_amt"),t.i[Be]),Je(document.getElementById("fx_dly_time"),t.i[we]),Je(document.getElementById("fx_pan_amt"),t.i[ve]),Je(document.getElementById("fx_pan_freq"),t.i[Ee]),Je(document.getElementById("fx_dist"),t.i[pe]),Je(document.getElementById("fx_drive"),t.i[ge]),e&&Ze(),S.updateInstr(t.i)},et=function(){var e=parseInt(document.getElementById("bpm").value);e&&e>=10&&1e3>=e&&(C.rowLen=X(e),S.updateRowLen(C.rowLen))},tt=function(e){if(C.patternLen!==e){wt();var t,n,a,o,r,d;for(t=0;8>t;t++)for(n=0;l>n;n++){for(o=C.songData[t].c[n],r=[],d=[],a=0;4*e>a;a++)r[a]=0;for(a=0;2*e>a;a++)d[a]=0;for(a=0;a<Math.min(C.patternLen,e);a++)r[a]=o.n[a],r[a+e]=o.n[a+C.patternLen],r[a+2*e]=o.n[a+2*C.patternLen],r[a+3*e]=o.n[a+3*C.patternLen],d[a]=o.f[a],d[a+e]=o.f[a+C.patternLen];o.n=r,o.f=d}C.patternLen=e}},nt=function(){var e=parseInt(document.getElementById("rpp").value);e&&e>=1&&256>=e&&(tt(e),xn(),Yn(),Re(),je())},at=function(){var e,t,n;for(C.endPattern=u+1,e=u-1;e>=0;--e){for(n=!0,t=0;8>t;++t)if(C.songData[t].p[e]>0){n=!1;break}if(!n)break;C.endPattern--}et()},ot=function(){var e=document.getElementById("cover");e.style.visibility="visible",e=document.getElementById("dialog"),e.style.visibility="visible",Tn()},rt=function(){var e=document.getElementById("cover");e.style.visibility="hidden",e=document.getElementById("dialog"),e.style.visibility="hidden",Ln()},dt=function(e){var t=document.getElementById("dialog");t.innerHTML="";var n,a;n=document.createElement("img"),n.src=r+"progress.gif",t.appendChild(n),n=document.createTextNode(e),t.appendChild(n),n=document.createElement("div"),n.id="progressBarParent",t.appendChild(n),a=document.createElement("div"),a.id="progressBar",n.appendChild(a),ot()},it=function(e){var t=Le(e);t&&(wt(),C=t,Se(),Ae(),Re(),je(),$e(!0))},st=function(){var e=document.getElementById("dialog");e.innerHTML="";var t;t=document.createElement("h3"),t.appendChild(document.createTextNode("Open song")),e.appendChild(t),e.appendChild(document.createElement("br"));var n=document.createElement("form"),a=document.createElement("div");a.style.textAlign="left",a.style.marginLeft="30px",a.style.lineHeight="1.8em";for(var o=[],r=0;r<gDemoSongs.length;r++)t=document.createElement("input"),t.type="radio",t.name="radiogroup1",t.value=gDemoSongs[r].name,0===r&&(t.checked=!0),o.push(t),a.appendChild(t),t=document.createElement("span"),t.innerHTML=gDemoSongs[r].description,a.appendChild(t),a.appendChild(document.createElement("br"));var d=document.createElement("input");d.type="radio",d.name="radiogroup1",d.value="custom",a.appendChild(d),a.appendChild(document.createTextNode(" Data URL: "));var i=document.createElement("input");i.type="text",i.size="45",i.title="Paste a saved song data URL here",i.onchange=function(){d.checked=!0},i.onkeydown=i.onchange,i.onclick=i.onchange,a.appendChild(i),n.appendChild(a),t=document.createElement("p"),t.appendChild(document.createTextNode("Hint: You can also drag'n'drop binary files into the editor.")),n.appendChild(t),n.appendChild(document.createElement("br")),t=document.createElement("input"),t.type="submit",t.value="Open",t.title="Open song",t.onclick=function(e){e.preventDefault();var t=null;if(d.checked){var n=G(i.value);t=H(n&&n.data&&n.data[0])}else for(var a=0;a<o.length;a++)if(e=o[a],e.checked){for(var r=0;r<gDemoSongs.length;r++)if(gDemoSongs[r].name===e.value){t=gDemoSongs[r].data?gDemoSongs[r].data:H(gDemoSongs[r].base64);break}break}t&&it(t),rt()},n.appendChild(t),n.appendChild(document.createTextNode(" ")),t=document.createElement("input"),t.type="submit",t.value="Cancel",t.onclick=function(){return rt(),!1},n.appendChild(t),e.appendChild(n),ot()},ct=function(){var e=document.getElementById("dialog");e.innerHTML="";var t,n;t=document.createElement("h3"),t.appendChild(document.createTextNode("Save song")),e.appendChild(t),t=document.createElement("p"),t.appendChild(document.createTextNode("Data URL (copy/paste, bookmark, mail etc):")),e.appendChild(t),t=document.createElement("p"),n=document.createElement("a");var a=V(ye(C)),o=a.length<70?a:a.slice(0,67)+"...";n.href=a,n.title=a,n.appendChild(document.createTextNode(o)),t.appendChild(n),e.appendChild(t);var r=document.createElement("form");t=document.createElement("input"),t.type="submit",t.value="Save binary",t.title="Save the song as a binary file.",t.onclick=function(){var e="data:application/octet-stream;base64,"+btoa(ye(C));return window.open(e),rt(),!1},r.appendChild(t),t=document.createElement("input"),t.type="submit",t.value="Close",t.onclick=function(){return rt(),!1},r.appendChild(t),e.appendChild(r),ot()},ut=function(){var e=document.getElementById("dialog");e.innerHTML="";var t;t=document.createElement("img"),t.src=r+"logo-big.png",e.appendChild(t),t=document.createElement("p"),t.appendChild(document.createTextNode("an HTML5 synth music tracker")),e.appendChild(t),t=document.createElement("p"),t.innerHTML='Licensed under the <a href="LICENSE">GPL v3</a> license (get the <a href="http://gitorious.org/soundbox/soundbox">source</a>).',t.style.fontStyle="italic",e.appendChild(t),t=document.createElement("p"),t.appendChild(document.createTextNode("To get started, open a demo song.")),e.appendChild(t),t=document.createElement("a"),t.href="help.html",t.appendChild(document.createTextNode("Help")),e.appendChild(t),e.appendChild(document.createElement("br")),e.appendChild(document.createElement("br"));var n=document.createElement("form");t=document.createElement("input"),t.type="submit",t.value="Close",t.onclick=function(){return rt(),!1},n.appendChild(t),e.appendChild(n),ot()},lt=function(e){e.preventDefault(),ut()},mt=function(e){return C=he(),Se(),Ae(),Re(),je(),$e(),qe(s),Ge(0,0),Ve(0,0),We(0),!1},ft=function(e){e.preventDefault(),st()},pt=function(e){at(),ct(),e.preventDefault()},gt=function(e){e.preventDefault(),at();var t=function(e){var t=new Blob([e],{type:"application/octet-stream"});saveAs(t,"SoundBox-music.wav")};Bt(t)},vt=function(e){at();var t="data:text/javascript;base64,"+btoa(Te(C));return window.open(t),!1},Et=function(e){document.getElementById("statusText").innerHTML=e},Bt=function(e,t){dt("Generating sound...");var n=new Date;P=new CPlayer,P.generate(C,t,function(t){var a=document.getElementById("progressBar");if(a.style.width=Math.floor(200*t)+"px",t>=1){var o=P.createWave(),r=new Date;Et("Generation time: "+(r.getTime()-n.getTime())/1e3+"s"),rt(),e(o)}})},wt=function(){kt(),k&&(k.pause(),M.reset())},ht=-1,yt=0,_t=0,It=0,Lt=0,Tt=!1,Dt=0,Ut=0,bt=function(e,t){for(var n=44100*e/C.rowLen,a=Math.floor(n),o=Math.floor(a/C.patternLen)+yt,r=a%C.patternLen,d=0;d<C.patternLen;++d){for(var i=o,s=r-d;0>s;){if(--i,yt>i)return-1;s+=C.patternLen}for(var c=C.songData[t].p[i]-1,u=0;4>u;u++)if(c>=0&&C.songData[t].c[c].n[s+u*C.patternLen]>0)return(d+(n-a))*C.rowLen}return-1},xt=function(e){var t=document.getElementById("playGfxCanvas"),n=N.width>0?N.width:t.width,a=N.height>0?N.height:51,o=t.getContext("2d");if(o){o.drawImage(N,0,0);var r=0,d=0;if(Tt&&e>=0){var i,s,c,u=P.getData(e,1e3),l=0,m=0,f=0,p=0;for(i=1;i<u.length;i+=2)s=u[i-1],c=u[i],l=.8*s+.1*l-.3*f,m=.8*c+.1*m-.3*p,f=s,p=c,r+=l*l,d+=m*m;r=.2*Math.sqrt(r/u.length)+.8*Dt,d=.2*Math.sqrt(d/u.length)+.8*Ut,Dt=r,Ut=d}var g=r>0?1.3+.5*Math.log(r):-1e3;g=-1>g?-1:g>1?1:g,g*=.57;var v=d>0?1.3+.5*Math.log(d):-1e3;for(v=-1>v?-1:v>1?1:v,v*=.57,o.strokeStyle="rgb(0,0,0)",o.beginPath(),o.moveTo(.25*n,2.1*a),o.lineTo(.25*n+1.8*a*Math.sin(g),2.1*a-1.8*a*Math.cos(g)),o.stroke(),o.beginPath(),o.moveTo(.75*n,2.1*a),o.lineTo(.75*n+1.8*a*Math.sin(v),2.1*a-1.8*a*Math.cos(v)),o.stroke(),o.fillStyle="rgb(0,0,0)",o.fillRect(0,a,n,20),i=0;8>i;++i){var E=Math.round(26+23*i);if(o.drawImage(O,E,a),i>=It&&Lt>=i){var B=C.songData[i].i[oe],w=C.songData[i].i[re],h=C.songData[i].i[de];B=B*B*4,h=w*w*4+h*h*4;var y=B+h;1e4>y&&(y=1e4,h=y-B);var _=bt(e,i);if(_>=0&&y>_){var I;I=B>_?_/B:1-(_-B)/h,o.globalAlpha=I*I,o.drawImage(q,E,a),o.globalAlpha=1}}}}},Yt=function(){if(null!=k){var e,t,n=M.currentTime();if(k.ended||k.duration&&k.duration-n<.1)return kt(),g=0,E=0,Re(),_=0,I=0,void je();var a=Math.floor(44100*n/C.rowLen),o=Math.floor(a/C.patternLen)+yt,r=a%C.patternLen,d=o!=w,i=d||r!=g;if(d)for(o>=0&&(w=o,y=o,Ae(!0,!0)),e=0;u>e;++e)t=document.getElementById("spr"+e),t.className=e==o?"playpos":"";if(i)for(r>=0&&(g=r,E=r,Re(!0,!d),_=r,I=r,je(!0,!d)),e=0;e<C.patternLen;++e)t=document.getElementById("ppr"+e),t.className=e==r?"playpos":"";xt(n)}},Ct=function(){w=yt,y=yt,h=B,Ae(!0,!0),Re(),je(),Tt=!0,ht=setInterval(Yt,16)},kt=function(){if(Tt){-1!==ht&&(clearInterval(ht),ht=-1);var e;for(e=0;u>e;++e)document.getElementById("spr"+e).className="";for(e=0;e<C.patternLen;++e)document.getElementById("ppr"+e).className="";xt(-1),Tt=!1}},Mt=function(e){e||(e=window.event),e.preventDefault(),wt(),at(),yt=0,_t=C.endPattern-2,It=0,Lt=7;var t=function(e){if(null==k)return void alert("Audio element unavailable.");try{Ct(),k.src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),M.reset(),k.play()}catch(t){alert("Error playing: "+t.message)}};Bt(t)},Pt=function(e){e||(e=window.event),e.preventDefault(),wt(),at();var t={firstRow:w,lastRow:y,firstCol:B,lastCol:h};yt=w,_t=y,It=B,Lt=h;var n=function(e){if(null==k)return void alert("Audio element unavailable.");try{Ct(),k.src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),k.play(),M.reset()}catch(t){alert("Error playing: "+t.message)}};Bt(n,t)},Nt=function(e){return e||(e=window.event),e.preventDefault(),null==k?void alert("Audio element unavailable."):void wt()},Ot=function(e){return qe(d),!0},qt=function(e){return qe(d),!0},St=function(e){return qe(d),!0},At=function(e){if(e||(e=window.event),e.preventDefault(),B==h){Y=[];for(var t=C.songData[B],n=0;n<=t.i.length;++n)Y[n]=t.i[n]}},Rt=function(e){if(e||(e=window.event),e.preventDefault(),B==h&&Y.length>0){var t=C.songData[B];t.i=[];for(var n=0;n<=Y.length;++n)t.i[n]=Y[n]}$e(!0)},Ft=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){b=[];for(var n=g;E>=n;++n){for(var a=[],o=p;v>=o;++o)a.push(C.songData[B].c[t].n[n+o*C.patternLen]);b.push(a)}}}},jt=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){for(var n=g,a=0;n<C.patternLen&&a<b.length;++n,++a)for(var o=p,r=0;4>o&&r<b[a].length;++o,++r)C.songData[B].c[t].n[n+o*C.patternLen]=b[a][r];Re()}}},Gt=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){for(var n=g;E>=n;++n)for(var a=p;v>=a;++a){var o=C.songData[B].c[t].n[n+a*C.patternLen];o>0&&(C.songData[B].c[t].n[n+a*C.patternLen]=o+1)}Re()}}},Ht=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){for(var n=g;E>=n;++n)for(var a=p;v>=a;++a){var o=C.songData[B].c[t].n[n+a*C.patternLen];o>1&&(C.songData[B].c[t].n[n+a*C.patternLen]=o-1)}Re()}}},Vt=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){for(var n=g;E>=n;++n)for(var a=p;v>=a;++a){var o=C.songData[B].c[t].n[n+a*C.patternLen];o>0&&(C.songData[B].c[t].n[n+a*C.patternLen]=o+12)}Re()}}},Xt=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){for(var n=g;E>=n;++n)for(var a=p;v>=a;++a){var o=C.songData[B].c[t].n[n+a*C.patternLen];o>12&&(C.songData[B].c[t].n[n+a*C.patternLen]=o-12)}Re()}}},Wt=function(e){e||(e=window.event),e.preventDefault(),U=[];for(var t=w;y>=t;++t){for(var n=[],a=B;h>=a;++a)n.push(C.songData[a].p[t]);U.push(n)}},Qt=function(e){e||(e=window.event),e.preventDefault();for(var t=w,n=0;u>t&&n<U.length;++t,++n)for(var a=B,o=0;8>a&&o<U[n].length;++a,++o)C.songData[a].p[t]=U[n][o];Ae()},zt=function(e){e||(e=window.event),e.preventDefault();for(var t=w;y>=t;++t)for(var n=B;h>=n;++n){var a=C.songData[n].p[t];l>a&&(C.songData[n].p[t]=a+1)}Ae(),Re(),je()},Jt=function(e){e||(e=window.event),e.preventDefault();for(var t=w;y>=t;++t)for(var n=B;h>=n;++n){var a=C.songData[n].p[t];a>0&&(C.songData[n].p[t]=a-1)}Ae(),Re(),je()},Kt=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){x=[];for(var n=_;I>=n;++n){var a=[];a.push(C.songData[B].c[t].f[n]),a.push(C.songData[B].c[t].f[n+C.patternLen]),x.push(a)}}}},Zt=function(e){if(e||(e=window.event),e.preventDefault(),w==y&&B==h){var t=C.songData[B].p[w]-1;if(t>=0){for(var n=_,a=0;n<C.patternLen&&a<x.length;++n,++a){var o=x[a];C.songData[B].c[t].f[n]=o[0],C.songData[B].c[t].f[n+C.patternLen]=o[1]}je()}}},$t=function(e){if(e||(e=window.event),B==h){var t=Pe(e),n=-1;"osc1_xenv"===t.id?n=K:"osc2_xenv"===t.id?n=ne:"lfo_fxfreq"===t.id&&(n=ue);var a;if(n>=0&&(a=C.songData[B].i[n]?0:1,C.songData[B].i[n]=a),m==c&&w==y&&_==I&&n){var o=C.songData[B].p[w]-1;o>=0&&(C.songData[B].c[o].f[_]=n+1,C.songData[B].c[o].f[_+C.patternLen]=a,je())}$e(!0),Oe(),e.preventDefault()}},en=function(e){if(e||(e=window.event),B==h){var t=Pe(e),n=0;if("osc1_wave_sin"===t.id?n=0:"osc1_wave_sqr"===t.id?n=1:"osc1_wave_saw"===t.id?n=2:"osc1_wave_tri"===t.id&&(n=3),m==c&&w==y&&_==I){var a=C.songData[B].p[w]-1;a>=0&&(C.songData[B].c[a].f[_]=Q+1,C.songData[B].c[a].f[_+C.patternLen]=n,je())}C.songData[B].i[Q]=n,$e(),Oe(),e.preventDefault()}},tn=function(e){if(e||(e=window.event),B==h){var t=Pe(e),n=0;if("osc2_wave_sin"===t.id?n=0:"osc2_wave_sqr"===t.id?n=1:"osc2_wave_saw"===t.id?n=2:"osc2_wave_tri"===t.id&&(n=3),
m==c&&w==y&&_==I){var a=C.songData[B].p[w]-1;a>=0&&(C.songData[B].c[a].f[_]=Z+1,C.songData[B].c[a].f[_+C.patternLen]=n,je())}C.songData[B].i[Z]=n,$e(!0),Oe(),e.preventDefault()}},nn=function(e){if(e||(e=window.event),B==h){var t=Pe(e),n=0;if("lfo_wave_sin"===t.id?n=0:"lfo_wave_sqr"===t.id?n=1:"lfo_wave_saw"===t.id?n=2:"lfo_wave_tri"===t.id&&(n=3),m==c&&w==y&&_==I){var a=C.songData[B].p[w]-1;a>=0&&(C.songData[B].c[a].f[_]=ie+1,C.songData[B].c[a].f[_+C.patternLen]=n,je())}C.songData[B].i[ie]=n,$e(!0),Oe(),e.preventDefault()}},an=function(e){if(e||(e=window.event),B==h){var t=Pe(e),n=2;if("fx_filt_hp"===t.id?n=1:"fx_filt_lp"===t.id?n=2:"fx_filt_bp"===t.id&&(n=3),m==c&&w==y&&_==I){var a=C.songData[B].p[w]-1;a>=0&&(C.songData[B].c[a].f[_]=le+1,C.songData[B].c[a].f[_+C.patternLen]=n,je())}C.songData[B].i[le]=n,$e(!0),Oe(),e.preventDefault()}},on=function(e){e||(e=window.event),e.preventDefault(),8>f&&(f++,document.getElementById("keyboardOctave").innerHTML=""+f)},rn=function(e){e||(e=window.event),e.preventDefault(),f>1&&(f--,document.getElementById("keyboardOctave").innerHTML=""+f)},dn=function(e){if(e||(e=window.event),B==h){var t=Pe(e),n=t.options[t.selectedIndex].value;if(""!==n&&(n=parseInt(n))){for(var a=gInstrumentPresets[n],o=0;o<a.i.length;++o)C.songData[B].i[o]=a.i[o];$e(!1),e.preventDefault()}}},sn=function(e){e||(e=window.event);var t=Ne(e,!0),n=0;if(t[1]<68)for(var a=0;a<R.length;a+=2)if(t[0]>=R[a]-10&&t[0]<=R[a]+10){n=R[a+1];break}if(!n){n=2*Math.floor(14*t[0]/420);var o=0;n>=20&&o++,n>=14&&o++,n>=6&&o++,n-=o}ze(n+12*f)&&e.preventDefault()},cn=function(e){if(e||(e=window.event),e.preventDefault(),!Tt){var t=Pe(e),n=parseInt(t.id.slice(3));We(n),D=!0}qe(c)},un=function(e){if(D){e||(e=window.event);var t=Pe(e),n=parseInt(t.id.slice(3));Qe(n),e.preventDefault()}},ln=function(e){if(D){e||(e=window.event);var t=Pe(e),n=parseInt(t.id.slice(3));Qe(n),D=!1,e.preventDefault()}},mn=function(e){if(e||(e=window.event),e.preventDefault(),!Tt){var t=Pe(e),n=parseInt(t.id.slice(2,3)),a=parseInt(t.id.slice(4));Ge(n,a),T=!0}qe(s)},fn=function(e){if(T){e||(e=window.event);var t=Pe(e),n=parseInt(t.id.slice(2,3)),a=parseInt(t.id.slice(4));He(n,a),e.preventDefault()}},pn=function(e){if(T){e||(e=window.event);var t=Pe(e),n=parseInt(t.id.slice(2,3)),a=parseInt(t.id.slice(4));He(n,a),T=!1,e.preventDefault()}},gn=function(e){e||(e=window.event);var t,n=Pe(e),a=parseInt(n.id.slice(2,3));t=Tt?w:parseInt(n.id.slice(4));var o=a!=B||B!=h;Ve(a,t),Tt||(L=!0),qe(i),Re(),je(),$e(o),e.preventDefault()},vn=function(e){if(L){e||(e=window.event);var t=Pe(e),n=parseInt(t.id.slice(2,3)),a=parseInt(t.id.slice(4));Xe(n,a),Re(),je(),$e(!0),e.preventDefault()}},En=function(e){if(L){e||(e=window.event);var t=Pe(e),n=parseInt(t.id.slice(2,3)),a=parseInt(t.id.slice(4)),o=n!=h||B!=h;Xe(n,a),L=!1,Re(),je(),$e(o),e.preventDefault()}},Bn=null,wn=function(e){B==h&&(e||(e=window.event),Bn=Pe(e),Oe(),e.preventDefault())},hn=function(e){if(e||(e=window.event),Bn){var t=Ne(e,!1),n=Me(Bn.parentNode),a=t[0]-6-n[0];a=0>a?0:a>191?1:a/191,Bn.sliderProps.nonLinear&&(a*=a);var o=Bn.sliderProps.min,r=Bn.sliderProps.max;a=Math.round(o+(r-o)*a);var d=-1;"osc1_vol"==Bn.id?d=z:"osc1_semi"==Bn.id?d=J:"osc2_vol"==Bn.id?d=$:"osc2_semi"==Bn.id?d=ee:"osc2_det"==Bn.id?d=te:"noise_vol"==Bn.id?d=ae:"env_att"==Bn.id?d=oe:"env_sust"==Bn.id?d=re:"env_rel"==Bn.id?d=de:"lfo_amt"==Bn.id?d=se:"lfo_freq"==Bn.id?d=ce:"fx_freq"==Bn.id?d=me:"fx_res"==Bn.id?d=fe:"fx_dist"==Bn.id?d=pe:"fx_drive"==Bn.id?d=ge:"fx_pan_amt"==Bn.id?d=ve:"fx_pan_freq"==Bn.id?d=Ee:"fx_dly_amt"==Bn.id?d=Be:"fx_dly_time"==Bn.id&&(d=we);var i=C.songData[B];if(m==c&&_==I&&w==y&&B==h){var s=C.songData[B].p[w]-1;s>=0&&(C.songData[B].c[s].f[_]=d+1,C.songData[B].c[s].f[_+C.patternLen]=a,je())}d>=0&&(i.i[d]=a),S.updateInstr(i.i),Je(Bn,a),Ze(),e.preventDefault()}},yn=function(e){return Bn?(Bn=null,!1):!0},_n=function(e){e||(e=window.event);var t,n,a,o=document.activeElement===document.getElementById("bpm")||document.activeElement===document.getElementById("rpp");if(m==i&&B==h&&w==y){if(e.keyCode>=48&&e.keyCode<=57)return C.songData[B].p[w]=e.keyCode-47,Ae(),Re(),je(),!1;if(e.keyCode>=64&&e.keyCode<=90)return C.songData[B].p[w]=e.keyCode-54,Ae(),Re(),je(),!1}if(m!=i&&!o){switch(a=-1,e.keyCode){case 90:a=0;break;case 83:a=1;break;case 88:a=2;break;case 68:a=3;break;case 67:a=4;break;case 86:a=5;break;case 71:a=6;break;case 66:a=7;break;case 72:a=8;break;case 78:a=9;break;case 74:a=10;break;case 77:a=11;break;case 188:a=12;break;case 76:a=13;break;case 190:a=14;break;case 186:a=15;break;case 191:a=16;break;case 81:a=12;break;case 50:a=13;break;case 87:a=14;break;case 51:a=15;break;case 69:a=16;break;case 82:a=17;break;case 53:a=18;break;case 84:a=19;break;case 54:a=20;break;case 89:a=21;break;case 55:a=22;break;case 85:a=23;break;case 73:a=24;break;case 57:a=25;break;case 79:a=26;break;case 48:a=27;break;case 80:a=28}if(a>=0&&ze(a+12*f))return!1}switch(e.keyCode){case 39:if(m==i)return Ve((B+1)%8,w),Re(),je(),$e(!0),!1;if(m==s)return Ge((p+1)%4,g),!1;break;case 37:if(m==i)return Ve((B-1+8)%8,w),Re(),je(),$e(!0),!1;if(m==s)return Ge((p-1+4)%4,g),!1;break;case 40:if(m==i)return Ve(B,(w+1)%u),Re(),je(),!1;if(m==s)return Ge(p,(g+1)%C.patternLen),!1;if(m==c)return We((_+1)%C.patternLen),!1;break;case 38:if(m==i)return Ve(B,(w-1+u)%u),Re(),je(),!1;if(m==s)return Ge(p,(g-1+C.patternLen)%C.patternLen),!1;if(m==c)return We((_-1+C.patternLen)%C.patternLen),!1;break;case 36:if(m==i)return Ve(B,0),Re(),je(),!1;if(m==s)return Ge(p,0),!1;if(m==c)return We(0),!1;break;case 35:if(m==i)return Ve(B,u-1),Re(),je(),!1;if(m==s)return Ge(p,C.patternLen-1),!1;if(m==c)return We(C.patternLen-1),!1;break;case 32:if(m!=d)return Pt(e),!1;break;case 8:case 46:if(m==i){for(t=w;y>=t;++t)for(n=B;h>=n;++n)C.songData[n].p[t]=0;return Ae(),Re(),je(),!1}if(m==s){if(w==y&&B==h){var r=C.songData[B].p[w]-1;if(r>=0){for(t=g;E>=t;++t)for(n=p;v>=n;++n)C.songData[B].c[r].n[t+n*C.patternLen]=0;g==E&&Ge(p,(g+1)%C.patternLen),Re()}return!1}}else if(m==c&&w==y&&B==h){var r=C.songData[B].p[w]-1;if(r>=0){for(t=_;I>=t;++t)C.songData[B].c[r].f[t]=0,C.songData[B].c[r].f[t+C.patternLen]=0;_==I&&We((_+1)%C.patternLen),je()}return!1}break;case 13:o&&(et(),nt(),document.getElementById("bpm").blur(),document.getElementById("rpp").blur())}return!0},In=function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;if(1!=t.length)return void alert("Only open one file at a time.");var n=t[0],a=new FileReader;a.onload=function(e){it(H(e.target.result))},a.readAsDataURL(n)},Ln=function(){document.onmousedown=null,document.addEventListener("mousemove",hn,!1),document.addEventListener("touchmove",hn,!1),document.addEventListener("mouseup",yn,!1),document.addEventListener("touchend",yn,!1),document.onkeydown=_n;var e=document.body.parentNode;e.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("drop",In,!1)},Tn=function(){document.onmousedown=function(){return!0},document.onmousemove=null,document.onmouseup=null,document.onkeydown=null},Dn=function(){for(var e,t,n,a=document.getElementById("sequencer-table"),o=0;u>o;o++){e=document.createElement("tr"),o%4===0&&(e.className="beat"),t=document.createElement("th"),t.id="spr"+o,t.textContent=""+o,e.appendChild(t);for(var r=0;8>r;r++)n=document.createElement("td"),n.id="sc"+r+"r"+o,n.textContent=" ",n.addEventListener("mousedown",gn,!1),n.addEventListener("mouseover",vn,!1),n.addEventListener("mouseup",En,!1),e.appendChild(n);a.appendChild(e)}},Un=function(e){for(var t=1;t<e.children.length&&"beat"!==e.children[t].className;)t++;return t},bn=function(){var e=W(),t=4;return C.patternLen%3===0?t=3:C.patternLen%4===0?t=4:C.patternLen%2===0?t=2:C.patternLen%5===0&&(t=5),e/t>=40&&C.patternLen>24&&C.patternLen%(2*t)===0&&(t*=2),t},xn=function(){var e=bn(),t=document.getElementById("pattern-table");if(t.children.length!==C.patternLen||Un(t)!==e){for(;t.firstChild;)t.removeChild(t.firstChild);for(var n,a,o,r=0;r<C.patternLen;r++){n=document.createElement("tr"),r%e===0&&(n.className="beat"),a=document.createElement("th"),a.id="ppr"+r,a.textContent=""+r,n.appendChild(a);for(var d=0;4>d;d++)o=document.createElement("td"),o.id="pc"+d+"r"+r,o.textContent=" ",o.addEventListener("mousedown",mn,!1),o.addEventListener("mouseover",fn,!1),o.addEventListener("mouseup",pn,!1),n.appendChild(o);t.appendChild(n)}}},Yn=function(){var e=bn(),t=document.getElementById("fxtrack-table");if(t.children.length!==C.patternLen||Un(t)!==e){for(;t.firstChild;)t.removeChild(t.firstChild);for(var n,a,o=0;o<C.patternLen;o++)n=document.createElement("tr"),o%e===0&&(n.className="beat"),a=document.createElement("td"),a.id="fxr"+o,a.textContent=String.fromCharCode(160),a.addEventListener("mousedown",cn,!1),a.addEventListener("mouseover",un,!1),a.addEventListener("mouseup",ln,!1),n.appendChild(a),t.appendChild(n)}};this.init=function(){e=j(window.location.href),t=G(window.location.href),Ce(r+"progress.gif"),Ce(r+"box-uncheck.png"),Ce(r+"box-uncheck.png"),Ce(r+"wave-sin.png"),Ce(r+"wave-sin-sel.png"),Ce(r+"wave-saw.png"),Ce(r+"wave-saw-sel.png"),Ce(r+"wave-sqr.png"),Ce(r+"wave-sqr-sel.png"),Ce(r+"wave-tri.png"),Ce(r+"wave-tri-sel.png"),Ce(r+"filt-lp.png"),Ce(r+"filt-lp-sel.png"),Ce(r+"filt-hp.png"),Ce(r+"filt-hp-sel.png"),Ce(r+"filt-bp.png"),Ce(r+"filt-bp-sel.png"),Ce(r+"filt-n.png"),Ce(r+"filt-n-sel.png"),ke(),N.onload=function(){xt(-1)},O.onload=function(){xt(-1)},N.src=r+"playGfxBg.png",O.src=r+"led-off.png",q.src=r+"led-on.png",Dn(),document.getElementById("osc1_vol").sliderProps={min:0,max:255},document.getElementById("osc1_semi").sliderProps={min:92,max:164},document.getElementById("osc2_vol").sliderProps={min:0,max:255},document.getElementById("osc2_semi").sliderProps={min:92,max:164},document.getElementById("osc2_det").sliderProps={min:0,max:255,nonLinear:!0},document.getElementById("noise_vol").sliderProps={min:0,max:255},document.getElementById("env_att").sliderProps={min:0,max:255},document.getElementById("env_sust").sliderProps={min:0,max:255},document.getElementById("env_rel").sliderProps={min:0,max:255},document.getElementById("lfo_amt").sliderProps={min:0,max:255},document.getElementById("lfo_freq").sliderProps={min:0,max:16},document.getElementById("fx_freq").sliderProps={min:0,max:255,nonLinear:!0},document.getElementById("fx_res").sliderProps={min:0,max:254},document.getElementById("fx_dly_amt").sliderProps={min:0,max:255},document.getElementById("fx_dly_time").sliderProps={min:0,max:16},document.getElementById("fx_pan_amt").sliderProps={min:0,max:255},document.getElementById("fx_pan_freq").sliderProps={min:0,max:16},document.getElementById("fx_dist").sliderProps={min:0,max:255,nonLinear:!0},document.getElementById("fx_drive").sliderProps={min:0,max:255};try{k=new Audio,M.setAudioElement(k),k.addEventListener("canplay",function(){this.play()},!0)}catch(n){k=null}var a=H(t&&t.data&&t.data[0]),o=a?Le(a):null;C=o?o:he(),Se(),Ae(),Re(),je(),$e(!0),qe(s),Ve(0,0),Ge(0,0),document.getElementById("logo").onmousedown=lt,document.getElementById("newSong").onmousedown=mt,document.getElementById("openSong").onmousedown=ft,document.getElementById("saveSong").onmousedown=pt,document.getElementById("exportJS").onmousedown=vt,document.getElementById("exportWAV").onmousedown=gt,document.getElementById("playSong").onmousedown=Mt,document.getElementById("playRange").onmousedown=Pt,document.getElementById("stopPlaying").onmousedown=Nt,document.getElementById("about").onmousedown=lt,document.getElementById("bpm").onfocus=Ot,document.getElementById("rpp").onfocus=qt,document.getElementById("sequencerCopy").onmousedown=Wt,document.getElementById("sequencerPaste").onmousedown=Qt,document.getElementById("sequencerPatUp").onmousedown=zt,document.getElementById("sequencerPatDown").onmousedown=Jt,document.getElementById("patternCopy").onmousedown=Ft,document.getElementById("patternPaste").onmousedown=jt,document.getElementById("patternNoteUp").onmousedown=Gt,document.getElementById("patternNoteDown").onmousedown=Ht,document.getElementById("patternOctaveUp").onmousedown=Vt,document.getElementById("patternOctaveDown").onmousedown=Xt,document.getElementById("fxCopy").onmousedown=Kt,document.getElementById("fxPaste").onmousedown=Zt,document.getElementById("instrPreset").onfocus=St,document.getElementById("instrPreset").onchange=dn,document.getElementById("osc1_wave_sin").addEventListener("mousedown",en,!1),document.getElementById("osc1_wave_sin").addEventListener("touchstart",en,!1),document.getElementById("osc1_wave_sqr").addEventListener("mousedown",en,!1),document.getElementById("osc1_wave_sqr").addEventListener("touchstart",en,!1),document.getElementById("osc1_wave_saw").addEventListener("mousedown",en,!1),document.getElementById("osc1_wave_saw").addEventListener("touchstart",en,!1),document.getElementById("osc1_wave_tri").addEventListener("mousedown",en,!1),document.getElementById("osc1_wave_tri").addEventListener("touchstart",en,!1),document.getElementById("osc1_vol").addEventListener("mousedown",wn,!1),document.getElementById("osc1_vol").addEventListener("touchstart",wn,!1),document.getElementById("osc1_semi").addEventListener("mousedown",wn,!1),document.getElementById("osc1_semi").addEventListener("touchstart",wn,!1),document.getElementById("osc1_xenv").addEventListener("mousedown",$t,!1),document.getElementById("osc1_xenv").addEventListener("touchstart",$t,!1),document.getElementById("osc2_wave_sin").addEventListener("mousedown",tn,!1),document.getElementById("osc2_wave_sin").addEventListener("touchstart",tn,!1),document.getElementById("osc2_wave_sqr").addEventListener("mousedown",tn,!1),document.getElementById("osc2_wave_sqr").addEventListener("touchstart",tn,!1),document.getElementById("osc2_wave_saw").addEventListener("mousedown",tn,!1),document.getElementById("osc2_wave_saw").addEventListener("touchstart",tn,!1),document.getElementById("osc2_wave_tri").addEventListener("mousedown",tn,!1),document.getElementById("osc2_wave_tri").addEventListener("touchstart",tn,!1),document.getElementById("osc2_vol").addEventListener("mousedown",wn,!1),document.getElementById("osc2_vol").addEventListener("touchstart",wn,!1),document.getElementById("osc2_semi").addEventListener("mousedown",wn,!1),document.getElementById("osc2_semi").addEventListener("touchstart",wn,!1),document.getElementById("osc2_det").addEventListener("mousedown",wn,!1),document.getElementById("osc2_det").addEventListener("touchstart",wn,!1),document.getElementById("osc2_xenv").addEventListener("mousedown",$t,!1),document.getElementById("osc2_xenv").addEventListener("touchstart",$t,!1),document.getElementById("noise_vol").addEventListener("mousedown",wn,!1),document.getElementById("noise_vol").addEventListener("touchstart",wn,!1),document.getElementById("env_att").addEventListener("mousedown",wn,!1),document.getElementById("env_att").addEventListener("touchstart",wn,!1),document.getElementById("env_sust").addEventListener("mousedown",wn,!1),document.getElementById("env_sust").addEventListener("touchstart",wn,!1),document.getElementById("env_rel").addEventListener("mousedown",wn,!1),document.getElementById("env_rel").addEventListener("touchstart",wn,!1),document.getElementById("lfo_wave_sin").addEventListener("mousedown",nn,!1),document.getElementById("lfo_wave_sin").addEventListener("touchstart",nn,!1),document.getElementById("lfo_wave_sqr").addEventListener("mousedown",nn,!1),document.getElementById("lfo_wave_sqr").addEventListener("touchstart",nn,!1),document.getElementById("lfo_wave_saw").addEventListener("mousedown",nn,!1),document.getElementById("lfo_wave_saw").addEventListener("touchstart",nn,!1),document.getElementById("lfo_wave_tri").addEventListener("mousedown",nn,!1),document.getElementById("lfo_wave_tri").addEventListener("touchstart",nn,!1),document.getElementById("lfo_amt").addEventListener("mousedown",wn,!1),document.getElementById("lfo_amt").addEventListener("touchstart",wn,!1),document.getElementById("lfo_freq").addEventListener("mousedown",wn,!1),document.getElementById("lfo_freq").addEventListener("touchstart",wn,!1),document.getElementById("lfo_fxfreq").addEventListener("mousedown",$t,!1),document.getElementById("lfo_fxfreq").addEventListener("touchstart",$t,!1),document.getElementById("fx_filt_lp").addEventListener("mousedown",an,!1),document.getElementById("fx_filt_lp").addEventListener("touchstart",an,!1),document.getElementById("fx_filt_hp").addEventListener("mousedown",an,!1),document.getElementById("fx_filt_hp").addEventListener("touchstart",an,!1),document.getElementById("fx_filt_bp").addEventListener("mousedown",an,!1),document.getElementById("fx_filt_bp").addEventListener("touchstart",an,!1),document.getElementById("fx_freq").addEventListener("mousedown",wn,!1),document.getElementById("fx_freq").addEventListener("touchstart",wn,!1),document.getElementById("fx_res").addEventListener("mousedown",wn,!1),document.getElementById("fx_res").addEventListener("touchstart",wn,!1),document.getElementById("fx_dly_amt").addEventListener("mousedown",wn,!1),document.getElementById("fx_dly_amt").addEventListener("touchstart",wn,!1),document.getElementById("fx_dly_time").addEventListener("mousedown",wn,!1),document.getElementById("fx_dly_time").addEventListener("touchstart",wn,!1),document.getElementById("fx_pan_amt").addEventListener("mousedown",wn,!1),document.getElementById("fx_pan_amt").addEventListener("touchstart",wn,!1),document.getElementById("fx_pan_freq").addEventListener("mousedown",wn,!1),document.getElementById("fx_pan_freq").addEventListener("touchstart",wn,!1),document.getElementById("fx_dist").addEventListener("mousedown",wn,!1),document.getElementById("fx_dist").addEventListener("touchstart",wn,!1),document.getElementById("fx_drive").addEventListener("mousedown",wn,!1),document.getElementById("fx_drive").addEventListener("touchstart",wn,!1),document.getElementById("octaveDown").addEventListener("mousedown",rn,!1),document.getElementById("octaveDown").addEventListener("touchstart",rn,!1),document.getElementById("octaveUp").addEventListener("mousedown",on,!1),document.getElementById("octaveUp").addEventListener("touchstart",on,!1),document.getElementById("keyboard").addEventListener("mousedown",sn,!1),document.getElementById("keyboard").addEventListener("touchstart",sn,!1),document.getElementById("instrCopy").onmousedown=At,document.getElementById("instrPaste").onmousedown=Rt,Ye(),Ln(),a||ut(),S.start(),S.updateRowLen(C.rowLen)}};